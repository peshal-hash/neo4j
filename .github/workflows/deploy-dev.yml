name: Deploy to Azure Dev Environment

on:
  push:
    branches:
      - dev
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: write

env:
  AZURE_RESOURCE_GROUP: testing-containers
  AZURE_ACR_NAME: salesopttest
  AZURE_ENVIRONMENT_NAME: testAPContainerEnvironment
  AZURE_LOCATION: canadacentral
  AZURE_KEY_VAULT_NAME: salesopt-kv-test
  APP_NAME_ACTIVEPIECES: agentops
  PYTHON_VERSION: "3.11"

jobs:
  # The 'test' job would go here if you have one
  # ...

  deploy:
    name: Build and Deploy to Azure
    runs-on: ubuntu-latest
    # needs: test # Uncomment this if you have a 'test' job
    environment:
      name: development
      url: ${{ steps.deploy.outputs.app_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_STAGING_CREDENTIALS }}

      # The rest of your deploy job steps remain the same...
      - name: Set Correct Subscription Context
        run: |
          # This script ensures the correct Azure subscription is used
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          FOUND_SUB_ID=$(az group list --query "[?name=='${{ env.AZURE_RESOURCE_GROUP }}'].id" -o tsv | cut -d'/' -f3 | head -n 1)
          if [[ -n "$FOUND_SUB_ID" && "$FOUND_SUB_ID" != "$SUBSCRIPTION_ID" ]]; then
            echo "Resource group found in a different subscription. Switching..."
            az account set --subscription "$FOUND_SUB_ID"
          fi
          echo "Using subscription:"
          az account show --output table

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make deployment script executable
        run: chmod +x ./deployment/deploy.sh

      - name: Deploy to Azure Container Apps
        id: deploy
        run: |
          cd deployment
          chmod +x ./deploy.sh
          APP_URL=$(./deploy.sh --environment dev | tail -n 1)
          {
            echo "app_url<<EOF"
            echo "$APP_URL"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    if: failure() && needs.deploy

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_STAGING_CREDENTIALS }}

      - name: Check and cleanup failed deployments
        run: |
          APP_NAME="${{ env.APP_NAME_ACTIVEPIECES }}"
          echo "Checking $APP_NAME for unhealthy revisions..."
          az containerapp revision list \
            --name "$APP_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?properties.healthState=='Unhealthy'].name" -o tsv | \
          while read -r revision; do
            if [[ -n "$revision" ]]; then
              echo "Deactivating unhealthy revision: $revision"
              az containerapp revision deactivate --name "$APP_NAME" --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --revision "$revision"
            fi
          done
